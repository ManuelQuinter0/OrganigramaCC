<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama - Estructura Corporativa</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .chart-container {
            width: 100%;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
        }
        .header h2 {
            margin: 10px 0 0 0;
            font-size: 18px;
            opacity: 0.9;
            font-weight: normal;
        }
        .valores {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .valor {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-size: 16px;
        }
        
        /* Estilos para asegurar que botones y l√≠neas est√©n fuera */
        .org-chart .node-rect {
            stroke: none !important;
        }
        
        /* Estilos para TODAS las l√≠neas */
        .org-chart .link {
            stroke: #34495e !important;
            stroke-width: 4px !important;
            opacity: 0.8 !important;
            stroke-linecap: round !important;
        }
        
        .org-chart .expander {
            transform: translate(-15px, -15px) !important;
            z-index: 1000 !important;
        }
        
        .org-chart .node {
            overflow: visible !important;
        }
        
        /* Asegurar que todas las l√≠neas SVG tengan el mismo grosor */
        .chart-container svg path {
            stroke-width: 4px !important;
            stroke: #34495e !important;
        }
        
        .chart-container svg line {
            stroke-width: 4px !important;
            stroke: #34495e !important;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <div class="loading" id="loading">
            Cargando datos del organigrama...
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

    <script>
        // CONFIGURACI√ìN - REEMPLAZA CON TU URL DE GOOGLE SHEETS
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/TU_ID_DE_HOJA_DE_C√ÅLCULO/gviz/tq?tqx=out:csv&sheet=NombreDeTuHoja';
        
        // Funci√≥n para cargar datos desde Google Sheets
        async function loadDataFromGoogleSheets() {
            try {
                // Mostrar loading
                document.getElementById('loading').innerHTML = 'Cargando datos del organigrama...';
                
                // NOTA: Para usar esta funci√≥n necesitas:
                // 1. Publicar tu Google Sheet (Archivo > Compartir > Publicar en web)
                // 2. Reemplazar la URL con la tuya
                // 3. Asegurarte que las columnas sean: id, parentId, nombre, tipo, descripcion, color, icon
                
                // Si no tienes la URL lista, puedes usar este ejemplo temporal:
                const demoData = [
                    {
                        id: "1",
                        parentId: "",
                        nombre: "Asamblea General de Accionistas",
                        tipo: "gobierno",
                        descripcion: "M√°ximo √≥rgano de gobierno",
                        color: "#2c3e50",
                        icon: "üèõÔ∏è"
                    },
                    {
                        id: "2", 
                        parentId: "1",
                        nombre: "Junta Directiva",
                        tipo: "gobierno",
                        descripcion: "Direcci√≥n estrat√©gica corporativa",
                        color: "#34495e",
                        icon: "üëë"
                    }
                ];
                
                // Por ahora usamos datos de demostraci√≥n
                // Descomenta la siguiente l√≠nea cuando tengas tu Google Sheet listo
                // const response = await fetch(GOOGLE_SHEETS_URL);
                // const csvText = await response.text();
                // const areasData = parseCSV(csvText);
                
                const areasData = demoData;
                
                // Ocultar loading
                document.getElementById('loading').style.display = 'none';
                
                return areasData;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">Error cargando datos: ' + error.message + 
                    '<br><br>Para conectar con Google Sheets:<br>' +
                    '1. Publica tu Sheet (Archivo > Compartir > Publicar en web)<br>' +
                    '2. Reemplaza la URL en la variable GOOGLE_SHEETS_URL</div>';
                return [];
            }
        }

        // Funci√≥n para parsear CSV
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Procesar datos
                if (row.id && row.id.trim() !== '') {
                    data.push({
                        id: row.id.trim(),
                        parentId: row.parentId ? row.parentId.trim() : '',
                        nombre: row.nombre ? row.nombre.trim() : '',
                        tipo: row.tipo ? row.tipo.trim() : 'general',
                        descripcion: row.descripcion ? row.descripcion.trim() : '',
                        color: row.color ? row.color.trim() : '#95a5a6',
                        icon: row.icon ? row.icon.trim() : 'üìã'
                    });
                }
            }
            
            return data;
        }

        // Funci√≥n para crear el organigrama
        function createOrgChart(areasData) {
            if (areasData.length === 0) {
                document.getElementById('loading').innerHTML = 
                    '<div class="error">No se encontraron datos para mostrar el organigrama</div>';
                return;
            }

            const chart = new d3.OrgChart()
                .nodeHeight((d) => 90)
                .nodeWidth((d) => 230)
                .childrenMargin((d) => 85)
                .compactMarginBetween((d) => 55)
                .compactMarginPair((d) => 45)
                .neighbourMargin((a, b) => 35)
                .siblingsMargin((d) => 25)
                .buttonContent(({ node, state }) => {
                    return `<div style="width:16px; height:16px; background:#34495e; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; border:1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-weight:bold;">
                        ${node.children ? '-' : '+'}
                    </div>`;
                })
                .nodeContent(function (d, i, arr, state) {
                    return `
                        <div style="width:${d.width}px;height:${d.height}px;padding:6px; position:relative; box-sizing:border-box;">
                            <div style="background:linear-gradient(135deg, ${d.data.color} 0%, ${d.data.color}99 100%); color:white; width:100%; height:100%; border-radius:8px; padding:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 2px solid ${d.data.color}33; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; box-sizing:border-box; position:relative;">
                                <!-- Tipo en esquina superior derecha -->
                                <div style="position:absolute; top:6px; right:6px; font-size:6px; background:rgba(255,255,255,0.25); padding:1px 4px; border-radius:4px; font-weight:bold;">
                                    ${d.data.tipo.toUpperCase()}
                                </div>
                                
                                <!-- Contenido principal -->
                                <div style="font-size:16px; margin-bottom:1px; flex-shrink:0;">${d.data.icon}</div>
                                <div style="font-size:11px; font-weight:bold; line-height:1.1; margin-bottom:0px; min-height:24px; display:flex; align-items:center; justify-content:center;">${d.data.nombre}</div>
                                <div style="font-size:8px; opacity:0.95; line-height:1.1; margin-bottom:2px; min-height:16px; display:flex; align-items:center; justify-content:center;">${d.data.descripcion}</div>
                            </div>
                        </div>
                    `;
                })
                .container('.chart-container')
                .data(areasData)
                .render();

            // Funci√≥n para aplicar grosor consistente a todas las l√≠neas
            function applyConsistentLineWidth() {
                d3.selectAll('.chart-container svg path')
                    .style('stroke-width', '4px')
                    .style('stroke', '#34495e')
                    .style('opacity', '0.8')
                    .style('stroke-linecap', 'round');
                
                d3.selectAll('.chart-container svg line')
                    .style('stroke-width', '4px')
                    .style('stroke', '#34495e')
                    .style('opacity', '0.8')
                    .style('stroke-linecap', 'round');
                
                d3.selectAll('.link')
                    .style('stroke-width', '4px')
                    .style('stroke', '#34495e')
                    .style('opacity', '0.8')
                    .style('stroke-linecap', 'round');
            }

            // Aplicar estilos consistentes
            setTimeout(() => {
                applyConsistentLineWidth();
                
                d3.selectAll('.expander')
                    .style('transform', 'translate(-15px, -15px)')
                    .style('z-index', '1000');
                
                d3.selectAll('.node')
                    .style('overflow', 'visible');
                    
                chart.fit().center();
            }, 300);

            // Observar cambios para aplicar estilos a nuevas l√≠neas
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        setTimeout(applyConsistentLineWidth, 50);
                    }
                });
            });

            observer.observe(document.querySelector('.chart-container'), {
                childList: true,
                subtree: true
            });

            return chart;
        }

        // Cargar datos y crear el organigrama
        async function initializeOrgChart() {
            const areasData = await loadDataFromGoogleSheets();
            createOrgChart(areasData);
        }

        // Inicializar
        initializeOrgChart();

    </script>
</body>
</html>