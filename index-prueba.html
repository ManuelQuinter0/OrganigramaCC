<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama - Constructora Centenario</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: url('https://constructoracentenario.com/wp-content/uploads/2024/04/LogoConstructoraCen2024.png') center center no-repeat;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chart-container {
            width: 98%;
            height: 98vh;
            background: rgba(173, 216, 230, 0.7);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: auto;
            padding: 5px;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #c0392b;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin: 20px;
        }
        
        .debug-info {
            text-align: left;
            padding: 20px;
            color: #2c3e50;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin: 10px;
            font-family: monospace;
            max-height: 200px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <div class="loading" id="loading">
            Conectando con Google Sheets...
        </div>
        <div id="debug"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

    <script>
        // URLs alternativas para probar
        const SHEET_URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vST1olXLCy87dbQ2oc8dsYL8LKL_K4cqbcBfiw51bsyFaPnSMGi446mahJ3AQw_Dph7ert2GSVDs516/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vST1olXLCy87dbQ2oc8dsYL8LKL_K4cqbcBfiw51bsyFaPnSMGi446mahJ3AQw_Dph7ert2GSVDs516/pub?output=csv'
        ];

        function debug(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug');
            if (debugDiv) {
                debugDiv.innerHTML += '<div>' + message + '</div>';
            }
        }

        // Funci√≥n para cargar datos desde Google Sheets
        async function loadDataFromGoogleSheets() {
            let lastError = '';
            
            // Probar diferentes URLs
            for (const sheetUrl of SHEET_URLS) {
                try {
                    debug('üîó Probando URL: ' + sheetUrl);
                    document.getElementById('loading').innerHTML = 'Conectando con Google Sheets...<br>' + sheetUrl;
                    
                    const response = await fetch(sheetUrl);
                    debug('üì° Status de respuesta: ' + response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    debug('‚úÖ Datos recibidos. Longitud: ' + csvText.length + ' caracteres');
                    debug('üìÑ Primeros 500 caracteres: ' + csvText.substring(0, 500));
                    
                    if (!csvText || csvText.trim() === '') {
                        throw new Error('El archivo CSV est√° vac√≠o');
                    }
                    
                    const areasData = parseCSV(csvText);
                    debug('üìä Datos parseados: ' + areasData.length + ' registros');
                    
                    if (areasData.length > 0) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('debug').style.display = 'none';
                        return areasData;
                    } else {
                        throw new Error('No se pudieron parsear datos del CSV');
                    }
                    
                } catch (error) {
                    lastError = error.message;
                    debug('‚ùå Error con URL: ' + error.message);
                    // Continuar con la siguiente URL
                }
            }
            
            // Si todas las URLs fallaron
            throw new Error('Todas las URLs fallaron. √öltimo error: ' + lastError);
        }

        // Funci√≥n para parsear CSV
        function parseCSV(csvText) {
            debug('üîç Parseando CSV...');
            
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            debug('üìè L√≠neas encontradas: ' + lines.length);
            
            if (lines.length === 0) {
                debug('‚ùå No hay l√≠neas para procesar');
                return [];
            }
            
            // Mostrar las primeras l√≠neas para debugging
            lines.slice(0, 3).forEach((line, index) => {
                debug('üìù L√≠nea ' + index + ': ' + line.substring(0, 100));
            });
            
            // Detectar separador
            const firstLine = lines[0];
            let separator = ',';
            if (firstLine.includes(';') && !firstLine.includes(',')) {
                separator = ';';
            } else if (firstLine.includes('\t')) {
                separator = '\t';
            }
            
            debug('üîß Separador detectado: "' + separator + '"');
            
            const headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, '').toLowerCase());
            debug('üè∑Ô∏è Headers: ' + JSON.stringify(headers));
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') continue;
                
                const values = parseCSVLine(line, separator);
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').trim().replace(/^"|"$/g, '');
                });
                
                debug('‚û°Ô∏è Procesando fila: ' + JSON.stringify(row));
                
                // Mapear diferentes nombres de columnas posibles
                const id = row.id || row['id'] || '';
                const parentId = row.parentid || row['parentid'] || row['parent id'] || row['parent'] || '';
                const nombre = row.nombre || row['nombre'] || row['name'] || row['cargo'] || '';
                const tipo = row.tipo || row['tipo'] || row['type'] || 'general';
                const descripcion = row.descripcion || row['descripcion'] || row['description'] || row['desc'] || '';
                const color = row.color || row['color'] || row['colour'] || '#95a5a6';
                const icon = row.icon || row['icon'] || row['emoji'] || 'üìã';
                
                if (id && id.trim() !== '') {
                    data.push({
                        id: id.trim(),
                        parentId: parentId ? parentId.trim() : '',
                        nombre: nombre ? nombre.trim() : 'Sin nombre',
                        tipo: tipo ? tipo.trim() : 'general',
                        descripcion: descripcion ? descripcion.trim() : '',
                        color: color ? color.trim() : '#95a5a6',
                        icon: icon ? icon.trim() : 'üìã'
                    });
                    debug('‚úÖ Fila agregada: ' + id + ' - ' + nombre);
                } else {
                    debug('‚ùå Fila sin ID, omitiendo: ' + JSON.stringify(row));
                }
            }
            
            debug('üéâ Total de datos procesados: ' + data.length);
            return data;
        }

        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Funci√≥n para crear el organigrama
        function createOrgChart(areasData) {
            if (areasData.length === 0) {
                const errorHTML = `
                    <div class="error">
                        No se encontraron datos para mostrar el organigrama<br><br>
                        Por favor verifica:<br>
                        1. Que el Google Sheet est√© publicado correctamente<br>
                        2. Que tenga datos en las columnas: id, parentId, nombre, tipo, descripcion, color, icon<br>
                        3. Que la primera fila tenga los nombres de las columnas<br>
                        4. Revisa la consola (F12) para m√°s detalles
                    </div>
                `;
                document.getElementById('loading').innerHTML = errorHTML;
                return;
            }

            debug('üöÄ Creando organigrama con ' + areasData.length + ' elementos');
            
            // Mientras tanto, mostrar datos de ejemplo para probar
            const chart = new d3.OrgChart()
                .nodeHeight((d) => 90)
                .nodeWidth((d) => 230)
                .childrenMargin((d) => 85)
                .compactMarginBetween((d) => 55)
                .compactMarginPair((d) => 45)
                .neighbourMargin((a, b) => 35)
                .siblingsMargin((d) => 25)
                .buttonContent(({ node, state }) => {
                    return `<div style="width:16px; height:16px; background:#2c3e50; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; border:1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-weight:bold;">
                        ${node.children ? '-' : '+'}
                    </div>`;
                })
                .nodeContent(function (d, i, arr, state) {
                    return `
                        <div style="width:${d.width}px;height:${d.height}px;padding:6px; position:relative; box-sizing:border-box;">
                            <div style="background:linear-gradient(135deg, ${d.data.color} 0%, ${d.data.color}99 100%); color:white; width:100%; height:100%; border-radius:8px; padding:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 2px solid ${d.data.color}33; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; box-sizing:border-box; position:relative;">
                                <div style="position:absolute; top:6px; right:6px; font-size:6px; background:rgba(255,255,255,0.25); padding:1px 4px; border-radius:4px; font-weight:bold;">
                                    ${d.data.tipo.toUpperCase()}
                                </div>
                                <div style="font-size:16px; margin-bottom:1px; flex-shrink:0;">${d.data.icon}</div>
                                <div style="font-size:11px; font-weight:bold; line-height:1.1; margin-bottom:0px; min-height:24px; display:flex; align-items:center; justify-content:center;">${d.data.nombre}</div>
                                <div style="font-size:8px; opacity:0.95; line-height:1.1; margin-bottom:2px; min-height:16px; display:flex; align-items:center; justify-content:center;">${d.data.descripcion}</div>
                            </div>
                        </div>
                    `;
                })
                .container('.chart-container')
                .data(areasData)
                .render();

            // Aplicar estilos a las l√≠neas
            setTimeout(() => {
                d3.selectAll('.chart-container svg path, .chart-container svg line, .link')
                    .style('stroke-width', '4px')
                    .style('stroke', '#2c3e50')
                    .style('opacity', '0.9')
                    .style('stroke-linecap', 'round');
                
                d3.selectAll('.expander')
                    .style('transform', 'translate(-15px, -15px)')
                    .style('z-index', '1000');
                
                d3.selectAll('.node')
                    .style('overflow', 'visible');
                    
                chart.fit().center();
                
                debug('üéä Organigrama renderizado correctamente!');
            }, 500);

            return chart;
        }

        // Inicializar
        async function initializeOrgChart() {
            try {
                const areasData = await loadDataFromGoogleSheets();
                createOrgChart(areasData);
            } catch (error) {
                debug('üí• Error cr√≠tico: ' + error.message);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">Error cargando datos: ' + error.message + 
                    '<br><br>Revisa la consola (F12) para m√°s detalles.</div>';
            }
        }

        // Iniciar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initializeOrgChart);
    </script>
</body>
</html>