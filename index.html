<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama - Estructura Corporativa</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .chart-container {
            width: 100%;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
        }
        .header h2 {
            margin: 10px 0 0 0;
            font-size: 18px;
            opacity: 0.9;
            font-weight: normal;
        }
        .valores {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .valor {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        /* Estilos para asegurar que botones y l√≠neas est√©n fuera */
        .org-chart .node-rect {
            stroke: none !important;
        }
        
        /* Estilos para TODAS las l√≠neas */
        .org-chart .link {
            stroke: #34495e !important;
            stroke-width: 4px !important;
            opacity: 0.8 !important;
            stroke-linecap: round !important;
        }
        
        .org-chart .expander {
            transform: translate(-15px, -15px) !important;
            z-index: 1000 !important;
        }
        
        .org-chart .node {
            overflow: visible !important;
        }
        
        /* Asegurar que todas las l√≠neas SVG tengan el mismo grosor */
        .chart-container svg path {
            stroke-width: 4px !important;
            stroke: #34495e !important;
        }
        
        .chart-container svg line {
            stroke-width: 4px !important;
            stroke: #34495e !important;
        }
    </style>
</head>
<body>
    
    <div class="chart-container"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

    <script>
        // Datos de estructura organizacional
        const areasData = [
            // ===== GOBIERNO CORPORATIVO =====
            {
                id: "1",
                parentId: "",
                nombre: "Asamblea General de Accionistas",
                tipo: "gobierno",
                descripcion: "M√°ximo √≥rgano de gobierno",
                color: "#2c3e50",
                icon: "üèõÔ∏è"
            },
            {
                id: "2", 
                parentId: "1",
                nombre: "Junta Directiva",
                tipo: "gobierno",
                descripcion: "Direcci√≥n estrat√©gica corporativa",
                color: "#34495e",
                icon: "üëë"
            },
            {
                id: "3",
                parentId: "1", 
                nombre: "Revisor√≠a Fiscal",
                tipo: "gobierno",
                descripcion: "Control y auditor√≠a interna",
                color: "#2c3e50",
                icon: "üìä"
            },

            // ===== ALTA DIRECCI√ìN =====
            {
                id: "4",
                parentId: "2",
                nombre: "Gerente General",
                tipo: "direccion",
                descripcion: "Direcci√≥n general operativa",
                color: "#e74c3c",
                icon: "üë®‚Äçüíº"
            },
            {
                id: "5",
                parentId: "2",
                nombre: "Presidente",
                tipo: "direccion", 
                descripcion: "Presidencia ejecutiva",
                color: "#c0392b",
                icon: "üéØ"
            },

            // ===== DEPARTAMENTO COMERCIAL (Gerente General) =====
            {
                id: "6",
                parentId: "4",
                nombre: "Departamento Comercial",
                tipo: "departamento",
                descripcion: "Gesti√≥n comercial",
                color: "#3498db",
                icon: "üí∞"
            },
            {
                id: "7",
                parentId: "6",
                nombre: "Gestor Comercial",
                tipo: "liderazgo",
                descripcion: "Jefatura comercial",
                color: "#2980b9",
                icon: "üìà"
            },
            {
                id: "8",
                parentId: "6",
                nombre: "Asistente de Cartera",
                tipo: "operativo",
                descripcion: "Gesti√≥n de cartera",
                color: "#3498db",
                icon: "üìã"
            },
            {
                id: "9",
                parentId: "6", 
                nombre: "Asistente de Legalizaciones",
                tipo: "operativo",
                descripcion: "Procesos legales",
                color: "#3498db",
                icon: "‚öñÔ∏è"
            },
            {
                id: "10",
                parentId: "6",
                nombre: "Asistente de Ventas", 
                tipo: "operativo",
                descripcion: "Soporte comercial",
                color: "#3498db",
                icon: "ü§ù"
            },
            {
                id: "11",
                parentId: "6",
                nombre: "Asesores Comerciales",
                tipo: "operativo",
                descripcion: "Ventas y desarrollo",
                color: "#3498db",
                icon: "üíº"
            },

            // ===== TESORER√çA (Gerente General) =====
            {
                id: "12",
                parentId: "4",
                nombre: "Tesorer√≠a",
                tipo: "financiero",
                descripcion: "Gesti√≥n financiera",
                color: "#27ae60",
                icon: "üè¶"
            },

            // ===== PERSONAL DE APOYO (Gerente General) =====
            {
                id: "13",
                parentId: "4",
                nombre: "Personal de Apoyo",
                tipo: "soporte",
                descripcion: "Soporte administrativo",
                color: "#95a5a6",
                icon: "üë•"
            },
            {
                id: "14",
                parentId: "13",
                nombre: "Mensajero",
                tipo: "operativo",
                descripcion: "Servicios de mensajer√≠a",
                color: "#7f8c8d",
                icon: "üöö"
            },
            {
                id: "15",
                parentId: "13",
                nombre: "Secretario de Gerencia",
                tipo: "administrativo", 
                descripcion: "Soporte directivo",
                color: "#95a5a6",
                icon: "üìù"
            },
            {
                id: "16",
                parentId: "13",
                nombre: "Servicios Generales",
                tipo: "operativo",
                descripcion: "Mantenimiento",
                color: "#7f8c8d",
                icon: "üîß"
            },
            {
                id: "17",
                parentId: "13", 
                nombre: "Conductor",
                tipo: "operativo",
                descripcion: "Transporte corporativo",
                color: "#7f8c8d",
                icon: "üöó"
            },

            // ===== DEPARTAMENTO T√âCNICO (Presidente) =====
            {
                id: "18",
                parentId: "5", 
                nombre: "Departamento T√©cnico",
                tipo: "tecnico",
                descripcion: "Direcci√≥n de obras",
                color: "#f39c12",
                icon: "üèóÔ∏è"
            },
            {
                id: "19",
                parentId: "18",
                nombre: "Director de Obra",
                tipo: "liderazgo",
                descripcion: "Direcci√≥n t√©cnica",
                color: "#e67e22",
                icon: "üë∑‚Äç‚ôÇÔ∏è"
            },
            {
                id: "20",
                parentId: "18",
                nombre: "Gestor de Proyectos", 
                tipo: "liderazgo",
                descripcion: "Gesti√≥n de proyectos",
                color: "#f39c12",
                icon: "üìê"
            },

            // ===== RESIDENTES DE OBRA (Departamento T√©cnico) =====
            {
                id: "21",
                parentId: "18",
                nombre: "Residentes de Obra",
                tipo: "supervision",
                descripcion: "Supervisi√≥n en sitio",
                color: "#d35400",
                icon: "üè≠"
            },
            {
                id: "22",
                parentId: "21",
                nombre: "Organismo Jur√≠dico",
                tipo: "especializado",
                descripcion: "Asesor√≠a legal",
                color: "#d35400",
                icon: "‚öñÔ∏è"
            },
            {
                id: "23",
                parentId: "21",
                nombre: "Maestros",
                tipo: "operativo",
                descripcion: "Oficios especializados",
                color: "#d35400",
                icon: "üî®"
            },
            {
                id: "24",
                parentId: "21",
                nombre: "Inspectores",
                tipo: "supervision",
                descripcion: "Control de calidad",
                color: "#d35400",
                icon: "üîç"
            },
            {
                id: "25",
                parentId: "21",
                nombre: "Oficiales",
                tipo: "operativo",
                descripcion: "Personal calificado",
                color: "#d35400",
                icon: "üë∑"
            },
            {
                id: "26",
                parentId: "21", 
                nombre: "Ayudantes",
                tipo: "operativo",
                descripcion: "Apoyo t√©cnico",
                color: "#d35400",
                icon: "üõ†Ô∏è"
            },
            {
                id: "27",
                parentId: "21",
                nombre: "Operarios",
                tipo: "operativo",
                descripcion: "Mano de obra",
                color: "#d35400",
                icon: "‚öíÔ∏è"
            },
            {
                id: "28",
                parentId: "21",
                nombre: "Aseadoras",
                tipo: "operativo",
                descripcion: "Limpieza y mantenimiento",
                color: "#d35400",
                icon: "üßπ"
            },

            // ===== TOPOGRAF√çA (Departamento T√©cnico) =====
            {
                id: "29",
                parentId: "18",
                nombre: "Top√≥grafo",
                tipo: "especializado",
                descripcion: "Jefatura topograf√≠a",
                color: "#16a085",
                icon: "üìè"
            },
            {
                id: "30", 
                parentId: "29",
                nombre: "Auxiliar de Topograf√≠a",
                tipo: "operativo",
                descripcion: "Trabajos de campo",
                color: "#138d75",
                icon: "üéØ"
            },
            {
                id: "31",
                parentId: "29",
                nombre: "Cadenero",
                tipo: "operativo",
                descripcion: "Mediciones topogr√°ficas",
                color: "#16a085",
                icon: "üìê"
            },

            // ===== ELECTRICIDAD (Departamento T√©cnico) =====
            {
                id: "32",
                parentId: "18",
                nombre: "Residente El√©ctrico",
                tipo: "especializado",
                descripcion: "Supervisi√≥n el√©ctrica",
                color: "#9b59b6",
                icon: "‚ö°"
            },
            {
                id: "33",
                parentId: "32",
                nombre: "Supervisor El√©ctrico",
                tipo: "supervision",
                descripcion: "Seguridad el√©ctrica",
                color: "#8e44ad",
                icon: "üîå"
            },

            // ===== SEGURIDAD Y SALUD (Departamento T√©cnico) =====
            {
                id: "34",
                parentId: "18",
                nombre: "Profesional en S.S.T.",
                tipo: "especializado",
                descripcion: "Seguridad laboral",
                color: "#e74c3c",
                icon: "üõ°Ô∏è"
            },
            {
                id: "35",
                parentId: "34",
                nombre: "Auxiliar S.S.T.",
                tipo: "operativo",
                descripcion: "Apoyo seguridad",
                color: "#c0392b",
                icon: "‚ö†Ô∏è"
            },
            {
                id: "36",
                parentId: "34",
                nombre: "Ayudantes S.S.T.",
                tipo: "operativo",
                descripcion: "Prevenci√≥n de riesgos",
                color: "#e74c3c",
                icon: "üöß"
            },

            // ===== SISTEMAS (Departamento T√©cnico) =====
            {
                id: "37",
                parentId: "18",
                nombre: "T√©cnico en Sistemas",
                tipo: "especializado",
                descripcion: "Soporte TI",
                color: "#3498db",
                icon: "üíª"
            },

            // ===== DEPARTAMENTO FINANCIERO (Presidente) =====
            {
                id: "38", 
                parentId: "5",
                nombre: "Departamento Financiero",
                tipo: "financiero",
                descripcion: "Gesti√≥n financiera",
                color: "#27ae60",
                icon: "üìä"
            },
            {
                id: "39",
                parentId: "38",
                nombre: "Director Financiero",
                tipo: "liderazgo",
                descripcion: "Direcci√≥n financiera",
                color: "#229954",
                icon: "üíπ"
            },

            // ===== PRESUPUESTOS (Departamento Financiero) =====
            {
                id: "40",
                parentId: "38",
                nombre: "Ingeniero de Presupuestos",
                tipo: "especializado",
                descripcion: "Control de presupuestos",
                color: "#27ae60",
                icon: "üìë"
            },
            {
                id: "41",
                parentId: "40",
                nombre: "Auxiliar de Presupuestos",
                tipo: "operativo",
                descripcion: "Soporte presupuestal",
                color: "#229954",
                icon: "üìã"
            },

            // ===== CONTABILIDAD (Departamento Financiero) =====
            {
                id: "42",
                parentId: "38",
                nombre: "Contador",
                tipo: "especializado",
                descripcion: "Contabilidad general",
                color: "#2ecc71",
                icon: "üßÆ"
            },
            {
                id: "43",
                parentId: "42",
                nombre: "Contador Junior",
                tipo: "operativo",
                descripcion: "Apoyo contable",
                color: "#27ae60",
                icon: "üìí"
            },

            // ===== GESTI√ìN DOCUMENTAL (Departamento Financiero) =====
            {
                id: "44",
                parentId: "38",
                nombre: "Asistente Gesti√≥n Documental",
                tipo: "administrativo",
                descripcion: "Control documental",
                color: "#27ae60",
                icon: "üìÅ"
            }
        ];

        // Crear el organigrama
        const chart = new d3.OrgChart()
            .nodeHeight((d) => 90)
            .nodeWidth((d) => 230)
            .childrenMargin((d) => 85)
            .compactMarginBetween((d) => 55)
            .compactMarginPair((d) => 45)
            .neighbourMargin((a, b) => 35)
            .siblingsMargin((d) => 25)
            .buttonContent(({ node, state }) => {
                return `<div style="width:16px; height:16px; background:#34495e; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; border:1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-weight:bold;">
                    ${node.children ? '-' : '+'}
                </div>`;
            })
            .nodeContent(function (d, i, arr, state) {
                return `
                    <div style="width:${d.width}px;height:${d.height}px;padding:6px; position:relative; box-sizing:border-box;">
                        <div style="background:linear-gradient(135deg, ${d.data.color} 0%, ${d.data.color}99 100%); color:white; width:100%; height:100%; border-radius:8px; padding:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 2px solid ${d.data.color}33; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; box-sizing:border-box; position:relative;">
                            <!-- Tipo en esquina superior derecha -->
                            <div style="position:absolute; top:6px; right:6px; font-size:6px; background:rgba(255,255,255,0.25); padding:1px 4px; border-radius:4px; font-weight:bold;">
                                ${d.data.tipo.toUpperCase()}
                            </div>
                            
                            <!-- Contenido principal -->
                            <div style="font-size:16px; margin-bottom:1px; flex-shrink:0;">${d.data.icon}</div>
                            <div style="font-size:11px; font-weight:bold; line-height:1.1; margin-bottom:0px; min-height:24px; display:flex; align-items:center; justify-content:center;">${d.data.nombre}</div>
                            <div style="font-size:8px; opacity:0.95; line-height:1.1; margin-bottom:2px; min-height:16px; display:flex; align-items:center; justify-content:center;">${d.data.descripcion}</div>
                        </div>
                    </div>
                `;
            })
            .container('.chart-container')
            .data(areasData)
            .render();

        // Funci√≥n para aplicar grosor consistente a todas las l√≠neas
        function applyConsistentLineWidth() {
            // Aplicar a todas las l√≠neas SVG
            d3.selectAll('.chart-container svg path')
                .style('stroke-width', '4px')
                .style('stroke', '#34495e')
                .style('opacity', '0.8')
                .style('stroke-linecap', 'round');
            
            d3.selectAll('.chart-container svg line')
                .style('stroke-width', '4px')
                .style('stroke', '#34495e')
                .style('opacity', '0.8')
                .style('stroke-linecap', 'round');
            
            // Aplicar tambi√©n a las l√≠neas de la librer√≠a
            d3.selectAll('.link')
                .style('stroke-width', '4px')
                .style('stroke', '#34495e')
                .style('opacity', '0.8')
                .style('stroke-linecap', 'round');
        }

        // Aplicar estilos consistentes despu√©s del render y en cada actualizaci√≥n
        setTimeout(() => {
            applyConsistentLineWidth();
            
            // Mover todos los botones fuera de los nodos
            d3.selectAll('.expander')
                .style('transform', 'translate(-15px, -15px)')
                .style('z-index', '1000');
            
            // Ajustar el contenedor de nodos para que no recorte
            d3.selectAll('.node')
                .style('overflow', 'visible');
                
            chart.fit().center();
        }, 300);

        // Observar cambios en el DOM para aplicar estilos a nuevas l√≠neas
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length) {
                    setTimeout(applyConsistentLineWidth, 50);
                }
            });
        });

        // Observar el contenedor del chart para cambios
        observer.observe(document.querySelector('.chart-container'), {
            childList: true,
            subtree: true
        });

    </script>
</body>
</html>